name: Create Infrastructure (Managed Identity)

on:
  workflow_dispatch:
    inputs:
      resourceGroupName:
        description: 'Name of the Resource Group'
        required: true
        default: 'NetBoxCI'
      location:
        description: 'Azure Region'
        required: true
        default: 'northeurope'
      clusterName:
        description: 'AKS Cluster Name'
        required: true
        default: 'aks-netbox-ci'
      kubernetesVersion:
        description: 'Kubernetes Version'
        required: true
        default: '1.29.9'
      nodeCount:
        description: 'Node Count'
        required: true
        default: '2'
      nodeSize:
        description: 'VM Size for Nodes'
        required: true
        default: 'Standard_B2ms'

permissions:
  id-token: write
  contents: read

jobs:
  create-infrastructure:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login (OIDC)
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Create Resource Group
        run: |
          # Check if resource group exists
          if az group exists --name ${{ github.event.inputs.resourceGroupName }}; then
            echo "Resource group ${{ github.event.inputs.resourceGroupName }} already exists"
          else
            echo "Creating resource group ${{ github.event.inputs.resourceGroupName }} with mandatory tags"
            az group create \
              --name ${{ github.event.inputs.resourceGroupName }} \
              --location ${{ github.event.inputs.location }} \
              --tags \
                "global.finops.company-code"="110" \
                "global.finops.cost-center"="2023" \
                "global.finops.cost-owner"="Bartosz.Sajkowski@securitas.com" \
                "global.finops.country"="Global" \
                "global.finops.project-code"="90" \
                "global.finops.project-name"="Non-Project" \
                "global.operation.environment"="sandbox" \
                "global.operation.governance"="GITSâ€‘E" \
                "global.operation.managed-by"="Jakub.Wdowiarek@securitas.com" \
                "global.tagging-version"="1.0"
          fi

      - name: Create AKS Cluster
        run: |
          bash ./scripts/create-aks.sh \
            ${{ github.event.inputs.resourceGroupName }} \
            ${{ github.event.inputs.clusterName }} \
            ${{ github.event.inputs.location }} \
            ${{ github.event.inputs.kubernetesVersion }} \
            ${{ github.event.inputs.nodeCount }} \
            ${{ github.event.inputs.nodeSize }}

      - name: Get AKS Credentials
        run: |
          az aks get-credentials \
            --resource-group ${{ github.event.inputs.resourceGroupName }} \
            --name ${{ github.event.inputs.clusterName }} \
            --admin

      - name: Create GitHub Runner Namespace
        run: |
          kubectl create namespace github-runners
          
      - name: Set Output Variables
        id: vars
        run: |
          echo "CLUSTER_NAME=${{ github.event.inputs.clusterName }}" >> $GITHUB_OUTPUT
          echo "RESOURCE_GROUP=${{ github.event.inputs.resourceGroupName }}" >> $GITHUB_OUTPUT
          echo "LOCATION=${{ github.event.inputs.location }}" >> $GITHUB_OUTPUT
      
      - name: Summary
        run: |
          echo "Infrastructure created successfully:"
          echo "Resource Group: ${{ github.event.inputs.resourceGroupName }}"
          echo "AKS Cluster: ${{ github.event.inputs.clusterName }}"
          echo "Location: ${{ github.event.inputs.location }}"
          echo "Kubernetes Version: ${{ github.event.inputs.kubernetesVersion }}"
          echo "Node Count: ${{ github.event.inputs.nodeCount }}"
          echo "Node Size: ${{ github.event.inputs.nodeSize }}"
