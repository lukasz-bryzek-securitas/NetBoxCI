name: Create Infrastructure (Managed Identity)

on:
  workflow_dispatch:
    inputs:
      resourceGroupName:
        description: 'Name of the Resource Group'
        required: true
        default: 'NetBoxCI'
      location:
        description: 'Azure Region'
        required: true
        default: 'northeurope'
      clusterName:
        description: 'AKS Cluster Name'
        required: true
        default: 'aks-netbox-ci'
      kubernetesVersion:
        description: 'Kubernetes Version'
        required: true
        default: '1.29.9'
      nodeCount:
        description: 'Node Count'
        required: true
        default: '2'
      nodeSize:
        description: 'VM Size for Nodes'
        required: true
        default: 'Standard_B2ms'

permissions:
  id-token: write
  contents: read

jobs:
  create-infrastructure:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login (Managed Identity)
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Create Resource Group
        run: |
          az group create \
            --name ${{ github.event.inputs.resourceGroupName }} \
            --location ${{ github.event.inputs.location }}

      - name: Create AKS Cluster
        run: |
          bash ./scripts/create-aks.sh \
            ${{ github.event.inputs.resourceGroupName }} \
            ${{ github.event.inputs.clusterName }} \
            ${{ github.event.inputs.location }} \
            ${{ github.event.inputs.kubernetesVersion }} \
            ${{ github.event.inputs.nodeCount }} \
            ${{ github.event.inputs.nodeSize }}

      - name: Get AKS Credentials
        run: |
          az aks get-credentials \
            --resource-group ${{ github.event.inputs.resourceGroupName }} \
            --name ${{ github.event.inputs.clusterName }} \
            --admin

      - name: Create GitHub Runner Namespace
        run: |
          kubectl create namespace github-runners
          
      - name: Set Output Variables
        id: vars
        run: |
          echo "CLUSTER_NAME=${{ github.event.inputs.clusterName }}" >> $GITHUB_OUTPUT
          echo "RESOURCE_GROUP=${{ github.event.inputs.resourceGroupName }}" >> $GITHUB_OUTPUT
          echo "LOCATION=${{ github.event.inputs.location }}" >> $GITHUB_OUTPUT
      
      - name: Summary
        run: |
          echo "Infrastructure created successfully:"
          echo "Resource Group: ${{ github.event.inputs.resourceGroupName }}"
          echo "AKS Cluster: ${{ github.event.inputs.clusterName }}"
          echo "Location: ${{ github.event.inputs.location }}"
          echo "Kubernetes Version: ${{ github.event.inputs.kubernetesVersion }}"
          echo "Node Count: ${{ github.event.inputs.nodeCount }}"
          echo "Node Size: ${{ github.event.inputs.nodeSize }}"
