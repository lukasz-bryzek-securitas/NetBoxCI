name: Create Infrastructure (Managed Identity)

on:
  workflow_dispatch:
    inputs:
      resourceGroupName:
        description: 'Name of the Resource Group'
        required: true
        default: 'NetBoxCI'
      location:
        description: 'Azure Region'
        required: true
        default: 'northeurope'
      clusterName:
        description: 'AKS Cluster Name'
        required: true
        default: 'aks-netbox-ci'
      kubernetesVersion:
        description: 'Kubernetes Version'
        required: true
        default: '1.28.9'
      nodeCount:
        description: 'Node Count'
        required: true
        default: '2'
      nodeSize:
        description: 'VM Size for Nodes'
        required: true
        default: 'Standard_B2ms'

permissions:
  id-token: write
  contents: read

jobs:
  create-infrastructure:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login (OIDC)
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Create Resource Group
        run: |
          # Check if resource group exists
          if az group exists --name ${{ github.event.inputs.resourceGroupName }}; then
            echo "Resource group ${{ github.event.inputs.resourceGroupName }} already exists"
          else
            echo "Creating resource group ${{ github.event.inputs.resourceGroupName }} with mandatory tags"
            az group create \
              --name ${{ github.event.inputs.resourceGroupName }} \
              --location ${{ github.event.inputs.location }} \
              --tags \
                "global.finops.company-code"="110" \
                "global.finops.cost-center"="2023" \
                "global.finops.cost-owner"="Bartosz.Sajkowski@securitas.com" \
                "global.finops.country"="Global" \
                "global.finops.project-code"="90" \
                "global.finops.project-name"="Non-Project" \
                "global.operation.environment"="sandbox" \
                "global.operation.governance"="GITS‑E" \
                "global.operation.managed-by"="Jakub.Wdowiarek@securitas.com" \
                "global.tagging-version"="1.0"
          fi

      - name: Register Azure Resource Providers
        run: |
          echo "🔄 Registering required Azure resource providers..."
          az provider register --namespace Microsoft.ContainerService --verbose
          az provider register --namespace Microsoft.Network --verbose
          az provider register --namespace Microsoft.Storage --verbose
          az provider register --namespace Microsoft.Compute --verbose
          az provider register --namespace Microsoft.ManagedIdentity --verbose
          
          echo "⏳ Waiting for Microsoft.ContainerService to register..."
          timeout=300  # 5 minutes timeout
          elapsed=0
          while [ $elapsed -lt $timeout ]; do
            status=$(az provider show --namespace Microsoft.ContainerService --query registrationState --output tsv)
            echo "Registration status: $status (elapsed: ${elapsed}s)"
            if [ "$status" = "Registered" ]; then
              echo "✅ Microsoft.ContainerService registered successfully!"
              break
            fi
            sleep 10
            elapsed=$((elapsed + 10))
          done
          
          if [ $elapsed -ge $timeout ]; then
            echo "❌ Timeout waiting for resource provider registration"
            exit 1
          fi

      - name: Get Latest Kubernetes Version
        id: k8s-version
        run: |
          echo "🔍 Getting latest available Kubernetes version for ${{ github.event.inputs.location }}..."
          LATEST_VERSION=$(az aks get-versions --location ${{ github.event.inputs.location }} --query 'orchestrators[?!isPreview].orchestratorVersion' --output tsv | sort -V | tail -n 1)
          echo "Available K8s version: $LATEST_VERSION"
          echo "K8S_VERSION=$LATEST_VERSION" >> $GITHUB_OUTPUT
          
          # Show all available versions for reference
          echo "All available versions:"
          az aks get-versions --location ${{ github.event.inputs.location }} --query 'orchestrators[?!isPreview].orchestratorVersion' --output tsv | sort -V

      - name: Create AKS Cluster
        run: |
          bash ./scripts/create-aks.sh \
            ${{ github.event.inputs.resourceGroupName }} \
            ${{ github.event.inputs.clusterName }} \
            ${{ github.event.inputs.location }} \
            ${{ steps.k8s-version.outputs.K8S_VERSION }} \
            ${{ github.event.inputs.nodeCount }} \
            ${{ github.event.inputs.nodeSize }}

      - name: Get AKS Credentials
        run: |
          az aks get-credentials \
            --resource-group ${{ github.event.inputs.resourceGroupName }} \
            --name ${{ github.event.inputs.clusterName }} \
            --admin

      - name: Create GitHub Runner Namespace
        run: |
          kubectl create namespace github-runners
          
      - name: Set Output Variables
        id: vars
        run: |
          echo "CLUSTER_NAME=${{ github.event.inputs.clusterName }}" >> $GITHUB_OUTPUT
          echo "RESOURCE_GROUP=${{ github.event.inputs.resourceGroupName }}" >> $GITHUB_OUTPUT
          echo "LOCATION=${{ github.event.inputs.location }}" >> $GITHUB_OUTPUT
      
      - name: Summary
        run: |
          echo "Infrastructure created successfully:"
          echo "Resource Group: ${{ github.event.inputs.resourceGroupName }}"
          echo "AKS Cluster: ${{ github.event.inputs.clusterName }}"
          echo "Location: ${{ github.event.inputs.location }}"
          echo "Kubernetes Version: ${{ steps.k8s-version.outputs.K8S_VERSION }} (auto-selected)"
          echo "Node Count: ${{ github.event.inputs.nodeCount }}"
          echo "Node Size: ${{ github.event.inputs.nodeSize }}"
