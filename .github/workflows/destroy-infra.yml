name: Destroy Infrastructure

on:
  workflow_dispatch:
    inputs:
      resourceGroupName:
        description: 'Name of the Resource Group'
        required: true
        default: 'NetBoxCI'
      confirmDestroy:
        description: 'Type "DESTROY" to confirm'
        required: true

permissions:
  id-token: write
  contents: read

jobs:
  destroy-infrastructure:
    runs-on: ubuntu-latest
    if: github.event.inputs.confirmDestroy == 'DESTROY'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login (OIDC)
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Verify Resource Group Exists
        id: verify-rg
        run: |
          echo "üîç Checking if resource group ${{ github.event.inputs.resourceGroupName }} exists..."
          
          if az group exists --name ${{ github.event.inputs.resourceGroupName }}; then
            echo "‚úÖ Resource group ${{ github.event.inputs.resourceGroupName }} found"
            echo "rg_exists=true" >> $GITHUB_OUTPUT
            
            # List resources in the group
            echo "üìã Resources in the group:"
            az resource list --resource-group ${{ github.event.inputs.resourceGroupName }} --output table
          else
            echo "‚ùå Resource group ${{ github.event.inputs.resourceGroupName }} does not exist"
            echo "rg_exists=false" >> $GITHUB_OUTPUT
          fi
          
          # Debug output
          echo "DEBUG: Output variable set to: $(grep rg_exists $GITHUB_OUTPUT || echo 'not found')"

      - name: Delete Resource Group
        if: steps.verify-rg.outputs.rg_exists == 'true'
        run: |
          echo "üö® WARNING: Deleting resource group ${{ github.event.inputs.resourceGroupName }} and ALL resources within it!"
          echo "This action cannot be undone."
          echo ""
          echo "üìù Deleting the following resources:"
          az resource list --resource-group ${{ github.event.inputs.resourceGroupName }} --query "[].{Name:name, Type:type, Location:location}" --output table
          echo ""
          
          echo "üóëÔ∏è Initiating resource group deletion..."
          
          # Execute deletion and capture output
          if DELETION_OUTPUT=$(az group delete --name ${{ github.event.inputs.resourceGroupName }} --yes --no-wait 2>&1); then
            echo "‚úÖ Resource group deletion command executed successfully!"
            echo "üìä Azure Response: $DELETION_OUTPUT"
            echo ""
            echo "üîÑ Deletion Status: IN PROGRESS"
            echo "üìç Resource Group: ${{ github.event.inputs.resourceGroupName }}"
            echo "‚è±Ô∏è Started: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            echo ""
            echo "üí° The deletion is running asynchronously in Azure."
            echo "   Use the verification steps below to monitor progress."
          else
            echo "‚ùå Error executing resource group deletion!"
            echo "üîç Error Details: $DELETION_OUTPUT"
            echo ""
            echo "üõ†Ô∏è Possible causes:"
            echo "   - Resource group is already being deleted"
            echo "   - Insufficient permissions"
            echo "   - Resources are locked or have dependencies"
            exit 1
          fi

      - name: Skip Deletion - Resource Group Not Found
        if: steps.verify-rg.outputs.rg_exists != 'true'
        run: |
          echo "‚ÑπÔ∏è No action taken - resource group ${{ github.event.inputs.resourceGroupName }} does not exist"
          echo "This might mean:"
          echo "  - The resource group was already deleted"
          echo "  - The resource group name is incorrect"
          echo "  - You don't have permissions to view this resource group"
          
      - name: Verification Instructions
        if: steps.verify-rg.outputs.rg_exists == 'true'
        run: |
          echo "üìä VERIFICATION STEPS:"
          echo ""
          echo "The resource group deletion runs asynchronously in Azure."
          echo "To monitor the deletion progress, you can:"
          echo ""
          echo "1. Check if the resource group still exists:"
          echo "   az group exists --name ${{ github.event.inputs.resourceGroupName }}"
          echo ""
          echo "2. Try to show the resource group (will fail when deleted):"
          echo "   az group show --name ${{ github.event.inputs.resourceGroupName }}"
          echo ""
          echo "3. List all resource groups to confirm deletion:"
          echo "   az group list --output table"
          echo ""
          echo "‚è±Ô∏è Typical deletion time: 2-5 minutes for small resource groups"
          echo "üí° Large resource groups with many resources may take longer"

      - name: Summary
        run: |
          echo "üéØ DESTROY INFRASTRUCTURE SUMMARY:"
          echo "================================="
          echo "Resource Group: ${{ github.event.inputs.resourceGroupName }}"
          echo "Confirmation: ${{ github.event.inputs.confirmDestroy }}"
          echo "RG Found: ${{ steps.verify-rg.outputs.rg_exists }}"
          echo "Status: ${{ steps.verify-rg.outputs.rg_exists == 'true' && 'Deletion initiated' || 'No action taken (RG not found)' }}"
          echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          if [ "${{ steps.verify-rg.outputs.rg_exists }}" == "true" ]; then
            echo "‚ö†Ô∏è IMPORTANT: This action cannot be undone!"
            echo "All resources in the resource group are being permanently deleted."
          else
            echo "‚ÑπÔ∏è No resources were deleted."
          fi
